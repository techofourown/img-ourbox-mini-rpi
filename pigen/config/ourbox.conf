# OurBox Matchbox image build config for pi-gen (OurBox repo mounted at /ourbox inside container)

# ---- Identity inputs (set these in CI or per-build) ----
OURBOX_PRODUCT="ourbox"
OURBOX_DEVICE="mini"
OURBOX_TARGET="${OURBOX_TARGET:-rpi}"            # e.g. rpi, rpi5, cm5, etc.
OURBOX_SKU="${OURBOX_SKU:-TOO-OBX-MBX-BASE-001}" # SKU identifier (part number)
OURBOX_VARIANT="${OURBOX_VARIANT:-prod}"         # prod | dev | ab-a | ab-b | exp-foo
OURBOX_VERSION="${OURBOX_VERSION:-dev}"          # v0.1.0 in releases; dev/ci locally

# Export identity inputs so pi-gen stage scripts (executed as subprocesses) can read them.
export OURBOX_PRODUCT OURBOX_DEVICE OURBOX_TARGET OURBOX_SKU OURBOX_VARIANT OURBOX_VERSION

# Lowercase slugs for filenames (keeps artifacts consistent)
OURBOX_SKU_SLUG="$(echo "${OURBOX_SKU}" | tr 'A-Z' 'a-z')"
OURBOX_VARIANT_SLUG="$(echo "${OURBOX_VARIANT}" | tr 'A-Z' 'a-z')"
OURBOX_TARGET_SLUG="$(echo "${OURBOX_TARGET}" | tr 'A-Z' 'a-z')"

# ---- Human-facing OS identity (keep it readable) ----
IMG_NAME="${OURBOX_PRODUCT}-${OURBOX_DEVICE}"
PI_GEN_RELEASE="OurBox OS for ${OURBOX_SKU} (${OURBOX_VARIANT})"
RELEASE="trixie"
TARGET_HOSTNAME="${OURBOX_PRODUCT}-${OURBOX_DEVICE}"

# ---- Artifact naming (this is what you ship/flash) ----
# ADR-friendly: img-<product>-<device>-<target>-<sku>[-<variant>]-<version>
OURBOX_ARTIFACT_BASE="img-${OURBOX_PRODUCT}-${OURBOX_DEVICE}-${OURBOX_TARGET_SLUG}-${OURBOX_SKU_SLUG}"

# Variant optional, but I recommend always setting it (even prod)
if [ -n "${OURBOX_VARIANT_SLUG}" ]; then
  OURBOX_ARTIFACT_BASE="${OURBOX_ARTIFACT_BASE}-${OURBOX_VARIANT_SLUG}"
fi

# Keep pi-gen's IMG_DATE as an actual date internally, but do not rely on it for naming.
# Build filename includes version (and you can include date/sha in OURBOX_VERSION if you want uniqueness).
IMG_FILENAME="${OURBOX_ARTIFACT_BASE}-${OURBOX_VERSION}"
ARCHIVE_FILENAME="${IMG_FILENAME}"

# ---- Deploy format ----
DEPLOY_COMPRESSION="xz"
COMPRESSION_LEVEL="6"

# ---- Stages ----
STAGE_LIST="/pi-gen/stage0 /pi-gen/stage1 /pi-gen/stage2 /ourbox/pigen/stages/stage-ourbox-mini"
