#!/usr/bin/env bash
set -euo pipefail

log(){ echo "[$(date -Is)] $*"; }

STATE_DIR="/var/lib/ourbox/state"
MARKER="${STATE_DIR}/bootstrap.done"

# idempotent
if [[ -f "$MARKER" ]]; then
  exit 0
fi

# hard requirement for product posture: donâ€™t bootstrap platform onto OS disk
if ! mountpoint -q /var/lib/ourbox; then
  echo "ERROR: /var/lib/ourbox is not mounted. Refusing to bootstrap." >&2
  exit 1
fi

mkdir -p \
  "$STATE_DIR" \
  "/var/lib/ourbox/device" \
  "/var/lib/ourbox/secrets" \
  "/var/lib/ourbox/k3s/agent/images"

# device_id (stable)
if [[ ! -f /var/lib/ourbox/device/device_id ]]; then
  cat /proc/sys/kernel/random/uuid > /var/lib/ourbox/device/device_id
fi
DEVICE_ID="$(cat /var/lib/ourbox/device/device_id)"

# k3s token (stable)
if [[ ! -f /var/lib/ourbox/secrets/k3s_token ]]; then
  head -c 32 /dev/urandom | od -An -tx1 | tr -d ' \n' > /var/lib/ourbox/secrets/k3s_token
  chmod 0600 /var/lib/ourbox/secrets/k3s_token
fi
TOKEN="$(cat /var/lib/ourbox/secrets/k3s_token)"

# Write k3s config (data-dir on DATA disk)
mkdir -p /etc/rancher/k3s
cat > /etc/rancher/k3s/config.yaml <<EOF_CONFIG
token: "${TOKEN}"
data-dir: /var/lib/ourbox/k3s
write-kubeconfig-mode: "0644"
disable:
  - servicelb
EOF_CONFIG

log "Hydrating airgap image tars into /var/lib/ourbox/k3s/agent/images"
# Hydrate images: copy ALL tars into k3s agent/images BEFORE starting.
shopt -s nullglob
cp -f /opt/ourbox/airgap/k3s/*.tar /var/lib/ourbox/k3s/agent/images/
cp -f /opt/ourbox/airgap/platform/images/*.tar /var/lib/ourbox/k3s/agent/images/
shopt -u nullglob

log "Hydrated tar files:"
ls -1 /var/lib/ourbox/k3s/agent/images/*.tar 2>/dev/null || true

# Fail fast with a clear message if memory controller isn't available
if [[ -f /sys/fs/cgroup/cgroup.controllers ]] && ! grep -qw memory /sys/fs/cgroup/cgroup.controllers; then
  echo "ERROR: cgroup v2 memory controller not enabled. k3s will fail." >&2
  echo "Expected: 'memory' in /sys/fs/cgroup/cgroup.controllers" >&2
  echo "Fix: ensure /boot/firmware/cmdline.txt includes:" >&2
  echo "  cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1" >&2
  exit 1
fi

# Start k3s (enabled only after hydration prep)
systemctl enable k3s.service
systemctl start k3s.service

# Wait for API
log "Waiting for k3s API..."
for i in $(seq 1 180); do
  if /usr/local/bin/k3s kubectl get nodes >/dev/null 2>&1; then
    log "k3s API is up"
    break
  fi
  if (( i % 5 == 0 )); then
    log "still waiting... (${i}/180)"
  fi
  sleep 1
done
/usr/local/bin/k3s kubectl get nodes >/dev/null

# Apply platform demo manifests (offline)
/usr/local/bin/k3s kubectl apply -f /opt/ourbox/airgap/platform/manifests

date -Is > "$MARKER"
echo "OurBox bootstrap complete. device_id=${DEVICE_ID}"
